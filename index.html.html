<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px;
      background: #f7f7f7;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      padding: 12px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 180px;
    }
    label {
      font-size: 13px;
      font-weight: 600;
    }
    select {
      padding: 4px 6px;
      font-size: 13px;
    }
    #plots {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .plot {
      flex: 1 1 420px;
      min-width: 360px;
      height: 420px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 8px;
    }
    #summary {
      margin-top: 16px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 12px;
      max-width: 960px;
    }
    #summary table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }
    #summary th, #summary td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: right;
    }
    #summary th {
      background: #f0f0f0;
      text-align: center;
    }
    #summary td:first-child {
      text-align: left;
    }
  </style>
</head>
<body>

<h1>Student Data Dashboard</h1>

<div id="controls">
  <div class="control-group">
    <label for="scatter-x">Scatterplot X-axis</label>
    <select id="scatter-x"></select>
  </div>
  <div class="control-group">
    <label for="scatter-y">Scatterplot Y-axis</label>
    <select id="scatter-y"></select>
  </div>
  <div class="control-group">
    <label for="scatter-color">Scatterplot color (optional)</label>
    <select id="scatter-color">
      <option value="">None</option>
    </select>
  </div>
  <div class="control-group">
    <label for="hist-var">Histogram variable</label>
    <select id="hist-var"></select>
  </div>
  <div class="control-group">
    <label for="filter-cat">Categorical filter (optional)</label>
    <select id="filter-cat">
      <option value="">No filter</option>
    </select>
  </div>
  <div class="control-group">
    <label for="filter-cat-value">Filter value</label>
    <select id="filter-cat-value">
      <option value="">All</option>
    </select>
  </div>
</div>

<div id="plots">
  <div id="scatter-plot" class="plot"></div>
  <div id="hist-plot" class="plot"></div>
</div>

<div id="summary">
  <h2 style="font-size:18px; margin-top:0;">Numeric variable summary (mean and standard deviation)</h2>
  <div id="summary-table-container"></div>
</div>

<script>
  // Path to your CSV file
  const CSV_FILE = "Student.csv";

  let rawData = [];
  let numericColumns = [];
  let categoricalColumns = [];

  function isNumeric(val) {
    if (val === null || val === undefined) return false;
    const v = ("" + val).replace(",", ".").trim(); // accept comma decimal
    if (v === "") return false;
    return !isNaN(parseFloat(v)) && isFinite(v);
  }

  function parseNumericColumn(data, col) {
    return data.map(d => {
      const v = d[col];
      if (isNumeric(v)) {
        return parseFloat(("" + v).replace(",", "."));
      }
      return null;
    });
  }

  function detectColumnTypes(data) {
    const cols = Object.keys(data[0] || {});
    const n = data.length;
    numericColumns = [];
    categoricalColumns = [];

    cols.forEach(col => {
      let numericCount = 0;
      data.forEach(row => {
        if (isNumeric(row[col])) numericCount++;
      });
      if (numericCount >= 0.7 * n) {
        numericColumns.push(col);
      } else {
        categoricalColumns.push(col);
      }
    });
  }

  function fillDropdown(selectId, options) {
    const sel = document.getElementById(selectId);
    sel.innerHTML = "";
    options.forEach(opt => {
      const o = document.createElement("option");
      o.value = opt;
      o.textContent = opt;
      sel.appendChild(o);
    });
  }

  function updateFilterValues() {
    const catCol = document.getElementById("filter-cat").value;
    const valSelect = document.getElementById("filter-cat-value");
    valSelect.innerHTML = "";
    const allOpt = document.createElement("option");
    allOpt.value = "";
    allOpt.textContent = "All";
    valSelect.appendChild(allOpt);

    if (!catCol) return;

    const values = Array.from(
      new Set(rawData.map(d => d[catCol]).filter(v => v !== null && v !== undefined && v !== ""))
    ).sort();

    values.forEach(v => {
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      valSelect.appendChild(o);
    });
  }

  function applyFilter(data) {
    const catCol = document.getElementById("filter-cat").value;
    const catVal = document.getElementById("filter-cat-value").value;
    if (!catCol || !catVal) return data;
    return data.filter(d => d[catCol] === catVal);
  }

  function makeScatterPlot() {
    const xCol = document.getElementById("scatter-x").value;
    const yCol = document.getElementById("scatter-y").value;
    const colorCol = document.getElementById("scatter-color").value;

    const filtered = applyFilter(rawData);
    const x = parseNumericColumn(filtered, xCol);
    const y = parseNumericColumn(filtered, yCol);

    let traces = [];
    if (colorCol) {
      const groups = {};
      filtered.forEach((d, i) => {
        if (x[i] === null || y[i] === null) return;
        const key = d[colorCol] ?? "NA";
        if (!groups[key]) groups[key] = { x: [], y: [], text: [] };
        groups[key].x.push(x[i]);
        groups[key].y.push(y[i]);
        groups[key].text.push(colorCol + ": " + key);
      });

      traces = Object.keys(groups).map(k => ({
        x: groups[k].x,
        y: groups[k].y,
        text: groups[k].text,
        mode: "markers",
        type: "scattergl",
        name: k,
        marker: { size: 7, opacity: 0.8 }
      }));
    } else {
      const xx = [];
      const yy = [];
      filtered.forEach((d, i) => {
        if (x[i] !== null && y[i] !== null) {
          xx.push(x[i]);
          yy.push(y[i]);
        }
      });
      traces = [{
        x: xx,
        y: yy,
        mode: "markers",
        type: "scattergl",
        name: "Observations",
        marker: { size: 7, opacity: 0.8 }
      }];
    }

    const layout = {
      margin: { l: 60, r: 20, t: 30, b: 60 },
      xaxis: { title: xCol, zeroline: false },
      yaxis: { title: yCol, zeroline: false },
      hovermode: "closest"
    };

    Plotly.newPlot("scatter-plot", traces, layout, { responsive: true });
  }

  function makeHistogram() {
    const col = document.getElementById("hist-var").value;
    const filtered = applyFilter(rawData);
    const values = parseNumericColumn(filtered, col).filter(v => v !== null);

    const trace = {
      x: values,
      type: "histogram",
      autobinx: true,
      name: col,
      opacity: 0.85
    };

    const layout = {
      margin: { l: 60, r: 20, t: 30, b: 60 },
      xaxis: { title: col },
      yaxis: { title: "Count" },
      bargap: 0.05
    };

    Plotly.newPlot("hist-plot", [trace], layout, { responsive: true });
  }

  function computeSummaryTable() {
    const container = document.getElementById("summary-table-container");
    if (numericColumns.length === 0) {
      container.innerHTML = "<p>No numeric columns detected.</p>";
      return;
    }

    let html = "<table><thead><tr><th>Variable</th><th>Mean</th><th>Std. dev.</th></tr></thead><tbody>";

    numericColumns.forEach(col => {
      const vals = parseNumericColumn(rawData, col).filter(v => v !== null);
      if (vals.length === 0) return;
      const mean = vals.reduce((a, b) => a + b, 0) / vals.length;
      const var_ = vals.reduce((a, b) => a + (b - mean) * (b - mean), 0) / (vals.length - 1);
      const sd = Math.sqrt(var_);
      html += `<tr><td>${col}</td><td>${mean.toFixed(2)}</td><td>${sd.toFixed(2)}</td></tr>`;
    });

    html += "</tbody></table>";
    container.innerHTML = html;
  }

  function setupControls() {
    // Populate basic dropdowns
    fillDropdown("scatter-x", numericColumns);
    fillDropdown("scatter-y", numericColumns);
    fillDropdown("hist-var", numericColumns);

    // Color dropdown: none + categorical columns
    const colorSel = document.getElementById("scatter-color");
    colorSel.innerHTML = "";
    const noneOpt = document.createElement("option");
    noneOpt.value = "";
    noneOpt.textContent = "None";
    colorSel.appendChild(noneOpt);
    categoricalColumns.forEach(col => {
      const o = document.createElement("option");
      o.value = col;
      o.textContent = col;
      colorSel.appendChild(o);
    });

    // Filter category dropdown
    const filterCatSel = document.getElementById("filter-cat");
    filterCatSel.innerHTML = "";
    const noFilterOpt = document.createElement("option");
    noFilterOpt.value = "";
    noFilterOpt.textContent = "No filter";
    filterCatSel.appendChild(noFilterOpt);
    categoricalColumns.forEach(col => {
      const o = document.createElement("option");
      o.value = col;
      o.textContent = col;
      filterCatSel.appendChild(o);
    });

    // Initial filter values list
    updateFilterValues();

    // Event listeners
    document.getElementById("scatter-x").addEventListener("change", makeScatterPlot);
    document.getElementById("scatter-y").addEventListener("change", makeScatterPlot);
    document.getElementById("scatter-color").addEventListener("change", makeScatterPlot);
    document.getElementById("hist-var").addEventListener("change", makeHistogram);

    document.getElementById("filter-cat").addEventListener("change", () => {
      updateFilterValues();
      makeScatterPlot();
      makeHistogram();
    });

    document.getElementById("filter-cat-value").addEventListener("change", () => {
      makeScatterPlot();
      makeHistogram();
    });
  }

  function initDashboard(data) {
    rawData = data;
    detectColumnTypes(rawData);

    if (numericColumns.length < 1) {
      alert("No numeric columns detected in Student.csv.");
      return;
    }

    setupControls();
    makeScatterPlot();
    makeHistogram();
    computeSummaryTable();
  }

  // Load the CSV and initialize
  d3.csv(CSV_FILE).then(data => {
    initDashboard(data);
  }).catch(err => {
    console.error("Error loading CSV:", err);
    alert("Failed to load Student.csv. Make sure the file is in the same folder and served via a local web server.");
  });

  // Resize plots on window resize
  window.addEventListener("resize", () => {
    Plotly.Plots.resize("scatter-plot");
    Plotly.Plots.resize("hist-plot");
  });
</script>

</body>
</html>
